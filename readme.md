# tpcc-util

## Описание

tpcc - утилита для упрощения работы с курсом tpcc-course-2018 в МФТИ.

## Установка

Для корректной установки утилиты вам потребуется установить python версии 3.5 или выше, 
а также установить `python venv`:
```bash
$ sudo apt-get install python3-venv
```

Обращаю внимание, что будет произведена попытка вызвать `/usr/bin/python3`, так как другие
версии (например, поставляемые с anaconda), ведут себя не так, как ожидается.

После этого можно выполнить установку, запустив
```bash
$ ./install.sh
```

В процессе установки будут загружены необходимые для работы пакеты, а также создана ссылка
`~/.local/bin/tpcc`. Если директории `~/.local/bin` не существовало или она не была добавлена
в переменную окружения `PATH`, можете добавить её для быстрого запуска утилиты.

Также в процессе установки будет создана папка `~/.tpcc`, в который будет находится конфигурационный
файл, а также логи и другие файлы, необходимые для работы приложения.
 
В случае проблем с установкой пишите, будем разбираться.

## Конфигурация

При установке будет создан файл `~/.tpcc/config.json` следующего содержания:
```json
{
        "gitlab_token": "<private_token>",
        "path_to_repos": "<path_to_solution>",
        "course_repo_name": "tpcc-course-2018",
        "group_number": "<group_number>",
        "first_name": "<first_name>",
        "last_name": "<last_name>",
        "assignee_username": "<assignee_nickname>",
        "gitlab_repo_user": "tpcc-course-2018",
        "test_before_merge": true
}
```

Для работы программы необходимо заполнить все имеющиеся поля. Получение токена для работы с
API GitLab подробно описан [здесь](https://docs.gitlab.com/ee/user/profile/personal_access_tokens.html).

## Использование

### Переключаемся на задачу

Всё взаимодействие с утилитой производится в формате `tpcc OPTION`. Первая опция, необходимая
для успешной работы: `task`. Основное и единственное назначение этой команды - смена текущей задачи
То есть, чтобы переключиться на задачу `1-mutex/futex`, достаточно вызвать
```bash
$ tpcc task 1-mutex/futex
```

Она обнаружит уже существующие по задаче файлы, создаст файл решения если его не существовало,
и даже подгрузит шаблон решения, если его название соответствует названию задачи, в данном случае - 
`futex.hpp`. Но к сожалению файл с шаблоном называется `solution_ref.hpp`, поэтому вы должны увидеть
что-то такое:

```text
Solution template futex.hpp not found. Specify solution template file:
        tpcc task --template <template_file> 1-mutex/futex
or specify --no-template option to create empty file:
        tpcc task --no-template 1-mutex/futex
``` 

Как мы видим, программа не нашла файл. поэтому сделаем, как нам советуют, и запустим
```bash
$ tpcc task --template solution_ref.hpp 1-mutex/futex
```

Также существует сокращённая версия:
```bash
$ tpcc task -t solution_ref.hpp 1-mutex/futex
```

Теперь, после того, как мы создали решение, хочется открыть его для редактирования. Для этого
хочется использовать команду `tpcc ide <ide_name>`, но она будет добавлена лишь в будущих версиях.

### Сборка и тестирование

Для того, чтобы проверить, собирается ли ваше решение, достаточно написать 
```bash
$ tpcc build
```

Это произведёт сборку `Makefile`'а, что эквивалентно запуску `cmake ..` в директории `build`
с указанием необходимого компилятора в параметрах cmake. Если на вашей системе не будет
обнаружен clang++ версии 5.0 или старше, то запуск `tpcc build` завершится с ошибкой.

Если же вызов build прошёл успешно, можно приступить к тестированию. Для тестирования опция
`test`, вызов которые выглядит следующим образом:

```bash
$ tpcc test TEST_TYPE
``` 

где `TEST_TYPE` - вид теста, который вы хотите запустить. Возможные опции: `asan`, `tsan`, 
`unit`, `stress` и `all`.

### Отправка решения

Теперь, когда решение собрано и протестировано, его хочется отправить в репозиторий. Для
этого есть опция `commit`, которая позволит вам отправить решение на GitLab. Чтобы это
сделать, достаточно переключиться на нужную задачу и написать

```bash
$ tpcc commit
```

В этот момент возникает вопрос: "А на той ли я вообще задаче?" Для ответа на него можно вызвать
```bash
$ tpcc status
```
что выведет
```text
1-mutex/futex
```

Итак, мы на нужной задаче, поэтому всё-таки вызовем
```bash
$ tpcc commit
```

Это создаст коммит с некоторым разумным комментарием и отправит его на GitLab. Если же вам
очень хочется написать своё сообщение, вы можете это сделать так же, как и в git'е:

```bash
$ tpcc commit -m "Я сделяль"
```

### Создание merge-request'а

Теперь, после того, как наше решение готово (по крайней мере, нам хочется в это верить),
нужно отправить решение на проверку семинаристу, создав merge-request. Для того, чтобы
не мучаться самостоятельно с выставлением проверяющего, тегов и т.д., существует опция
`merge`. Вызов
```bash
$ tpcc merge
```
приведёт к созданию merge-request'а с правильным названием, проставленными тегами и проверяющим,
которого вы указали в конфигурационном файле. Также этот вызов по умолчанию запустит все тесты,
чтобы удостовериться в корректности решения. Если этого хочется избежать, нужно добавить
специальный флаг `--no-tests`:

```bash
$ tpcc merge --no-tests
```

Если же вы хотите отключить тестирование перманентно, достаточно изменить в конфугурационном
файле ключ 
```json
"test_before_merge": false
```
